# 基于thrift开发的一个socket聊天室

## 记录一下开发的思路
1. 首先查看了thrift的相关文档，发现好像官网上给的东西很少，只看到了官方提供的一些例子

2. 根据官方提供的例子，进行二次封装，得到了两个可以快速开发的、通用的Server类和Client类

3. 可以在这两个类的基础上快速开发，将一些资源的管理同时封装进去，见fast_server_client.py

4. 然后就可以进行业务的开发了

    1. 明确具体要实现的功能，如下使用python实现基于thrift的在线聊天功能(聊指的是服务端起来后，再起多个客户端，在客户端发消息，可以实现下述功能)

    2. 聊天消息使用序列化后的数据传递，至少需要包含：消息发送方ip + 消息正文

    3. 默认所有加入的人可一起聊天

    4. 用户可以请求加入群组，实现群聊天，非群组的人不能收到消息

    5. 可选，只给群组里的某个人发消息

    6. 对上述功能的优化篇

        1.  增加用户注册，功能，且支持密码验证

        2. 接口实现的简单些，所以需要制定协议

        3. 此处使用类json协议，并且，后期还会指定更规范的文档

            ```
            response
                 {
                     "status": 200,
                     "content": "string",
                 }
                 
            message
                 {
                     "ip": "string",
                     "data": "string"
                 }
            
            request
                 {
                     "uid": "string",
                     "ip": "string",
                     "data": 
                     {
                         "msg": "MSG",
                         "other": "string"
                     }
                 }
            ```

    

    4.2 根据需求，我所想到的思路
        1. 我大概看了以下，此处说的序列化数据在传递，貌似thrift中提供了序列化的方案，比如TBinaryProtocolFactory，所以直接用就行了
            在每个client只管自己发送的消息，ip由程序封装进去，所以可以实现一个基本的发送消息的方法，内部有对ip的封装
        
       2. 默认加入，可以理解成登录后，所以人都在同一个集合(字典)中，会直接将用户的消息队列加入到这个有所人的字典中，也就可以进行多人聊天了
      注意，同时可以利用这个群组，因为key为用户的ID，value为用户的消息队列，专门用来接受消息，所以这个字典也可以作为用户的映射，供
      其他API使用

       3. 可以加入群组，那么肯定也得先有群组，所以必须提供用户创建群的方法，此处的实现策略是分级处理
      用户可以创建群，在server端的实现是，server本身维护了一个群组字典，以群名称作为key，集合作为value，注：该集合是所有加入到
      该群组里的用户的ID(此处实现为用户IP作为ID，说实话，测试的时候贼费劲，没准我会给他们生成个随机ID，以后在搞)，
      因此，用户创建群，其实就是在群组字典中增加个一个kv对，并默认将该用户添加到集合v中即可。
      现在群已经创建好了，那么其他的用户可以就可以加入到群里了，肯定又得提供一个添加群的方法，可能还得实现一个搜索群的方法，要可以判断该群
      是否存在，然后将该用户添加到群组字典中，已存在的群的集合中，完成。
      消息的发送，由于现在分了几级 

      ```
      global_group_dict
      {
           "group_name" : {"IP1", "IP2", ...}
      }
      ```

      

       4. 所以，当在创建的群里聊天的时候，client会通过指定的方法将消息发送到server端，注意：此处会有bug的，因为得判断用户是否在该群中，
      其实要判断的东西很多，我就不全部都考虑了，大概实现以下就好了，此处需要用户带上在群名字，这是关键，然后server
      会在global_group_dict中查找(当然，可以在前端加上一些限制，用户只能在添加的群中进行聊天)，一般能找到，然后得到当前群组中所有用户
      的集合，在根据集合中用户ID，从缺省字典中会找到他们的消息队列，将信息投递过去，完成信息的发

       5. 想进行私聊，跟3很像，用户也得调用server支持的方法，将群组名称和用户ID发送到server端，然后，server先查询该群组是否存在，如果存在，
      在判断要私聊的用户是否在这个群组中，如果在，直接通过global_group_dict得到该用户的消息队列，直接进行消息的单独投递，即可

5. 完成基本的功能，对其他一些东西的说明  (杂项)
    用户的消息队列：目前由于相当于就是跨主机跨网路的，当然也是跨进程的，所以为了简单，模拟实现下，此处直接用进程间通信的队列进行模拟，后期可以换成
        rabbitMQ等第三方队列

    有很多的设计方式，比如，用户的IP/ID到底是想通过传参进行传递，还是直接写到用户消息正文中去？考虑到以后的场景，其实都可以实现，如果是直接放到
    正文中去，那么在server端可以使用正则表达式引擎进行匹配，得到我们期望的数据，在进行拼凑之后投递信息，也可以直接用传参数的方式，这样可能编程时
    会容易一些。这些会影响到server handler的实现

    还没测试，我觉得还是别用用户的IP作为唯一标识好了，不然我测试的时候还得开好几个虚拟机，虚拟化技术我现在用的也不怎么滴，自己添加个ID把
    所以，用户在登录的时候，就指定自己的ID，我也不做ID的限制了，用随机数等其他的东西我自己测试也比较费劲，懂我意思就好




















